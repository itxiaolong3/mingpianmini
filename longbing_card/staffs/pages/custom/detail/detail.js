var _data,_echarts=require("../../../../templates/ec-canvas/echarts"),echarts=_interopRequireWildcard(_echarts),_xx_util=require("../../../../resource/js/xx_util.js"),_xx_util2=_interopRequireDefault(_xx_util),_index=require("../../../../resource/apis/index.js");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _interopRequireWildcard(t){if(t&&t.__esModule)return t;var a={};if(null!=t)for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(a[e]=t[e]);return a.default=t,a}function _toConsumableArray(t){if(Array.isArray(t)){for(var a=0,e=Array(t.length);a<t.length;a++)e[a]=t[a];return e}return Array.from(t)}function _defineProperty(t,a,e){return a in t?Object.defineProperty(t,a,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[a]=e,t}var app=getApp(),getAppGlobalData=require("../../../../templates/copyright/copyright.js");Page({data:(_data={globalData:[],tabList:[{status:"browse",name:"浏览记录"},{status:"follow",name:"跟进记录"},{status:"analysis",name:"AI分析"}],currentIndex:0,currentTab:"browse",Customer:[],currEditInd:-1,toFolledit:"toSave",content:"",date:"",startDate:"",page:1,dateindex:0,dateindex2:0},_defineProperty(_data,"content",""),_defineProperty(_data,"currentRadarTime",""),_defineProperty(_data,"viewList",{page:1,total_page:"",list:[],refresh:!1,loading:!1}),_defineProperty(_data,"followList",{page:1,total_page:"",list:[],refresh:!1,loading:!1}),_defineProperty(_data,"toFollowType",[]),_defineProperty(_data,"page",1),_defineProperty(_data,"more",!0),_defineProperty(_data,"isEmpty",!1),_defineProperty(_data,"index1","2"),_defineProperty(_data,"index2","2"),_defineProperty(_data,"Labellist",[]),_defineProperty(_data,"types",""),_defineProperty(_data,"ai_Interest",[]),_defineProperty(_data,"ai_Interest_x",[]),_defineProperty(_data,"ai_Interest_y",[]),_defineProperty(_data,"ai_active_x",[]),_defineProperty(_data,"ai_active_y",[]),_defineProperty(_data,"ai_Interaction",[]),_defineProperty(_data,"setInterest",[{name:"今日"},{name:"近7天"},{name:"近30天"},{name:"本月"}]),_defineProperty(_data,"interest",2),_defineProperty(_data,"setActivity",[{name:"近7天"},{name:"近30天"}]),_defineProperty(_data,"activity",1),_defineProperty(_data,"setClient",[{name:"今日"},{name:"近7天"},{name:"近30天"},{name:"本月"},{name:"全部"}]),_defineProperty(_data,"client",2),_defineProperty(_data,"firstTime",""),_defineProperty(_data,"RecordShow",!1),_defineProperty(_data,"vagueShow",!1),_defineProperty(_data,"textValue",""),_defineProperty(_data,"ec",{lazyLoad:!0}),_defineProperty(_data,"isShowFooter",!0),_data),onLoad:function(t){app.util.showLoading(1),wx.hideShareMenu(),t.type&&this.setData({types:t.type});var a={};t.id&&(a.id=t.id),t.fromstatus&&(a.fromstatus=t.fromstatus,a.staff_id=t.staffid,a.client_id=t.clientid),this.setData({param:a}),getApp().getConfigInfo(!0,!1).then(function(){var t=app.globalData,a=t.platform,e=t.configInfo.config,i=e.android_pay,o=e.ios_pay,r=!0;-1<a.indexOf("android")&&0==i&&(r=!1),-1<a.indexOf("ios")&&0==o&&(r=!1),n.setData({globalData:app.globalData,tmp_showPrice:r})}),this.getDealDate(),this.getRate(),this.firsttime(),this.ifOK();var n=this,e=n.data.currentTab;"browse"==e?n.toGetStaffView():"follow"==e?n.toGetStaffFollow():"analysis"==e&&(n.setData({isShowFooter:!1}),n.getAnalysis());var i=new app.util.date,o=(i.dateToLong(new Date)/1e3).toFixed(0);o=i.dateToStr("yyyy-MM-DD",i.longToDate(1e3*o)),n.setData({startDate:o,globalData:app.globalData}),app.util.request({url:"entry/wxapp/Staff",cachetime:"30",method:"POST",data:{target_id:n.data.param.id},success:function(t){var a=t.data.data.avatarUrl;n.setData({img2:a})}}),wx.hideLoading()},onReady:function(){},onShow:function(t){this.shuaxin(),this.biaoqian()},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){app.util.showLoading(1);var t=this;wx.showNavigationBarLoading(),getAppGlobalData.getAppGlobalData(t,_index.baseModel,_xx_util2.default);var a=t.data.currentTab;"browse"==a?t.setData({"viewList.refresh":!0,"viewList.page":1},function(){t.toGetStaffView()}):"follow"==a&&t.setData({"followList.refresh":!0,"followList.page":1},function(){t.toGetStaffFollow()}),t.shuaxin(),wx.stopPullDownRefresh(),wx.hideLoading()},onReachBottom:function(){var t=this;app.util.showLoading(1);var a=t.data,e=a.currentTab,i=a.viewList,o=a.followList;"browse"==e?i.page==i.total_page||i.loading||t.setData({"viewList.page":parseInt(i.page)+1,"viewList.loading":!1},function(){t.toGetStaffView()}):"follow"==e&&(o.page==o.total_page||o.loading||t.setData({"followList.page":parseInt(o.page)+1,"followList.loading":!1},function(){t.toGetStaffFollow()})),wx.hideLoading()},onPageScroll:function(t){},onShareAppMessage:function(t){},toGetStaffView:function(){var n=this,t=n.data,a=t.param,s=t.viewList,d=t.currentRadarTime,e={page:s.page,client_id:a.id};a.staff_id&&(e.staff_id=a.staff_id),s.refresh||_xx_util2.default.showLoading(),_index.staffModel.getClientView(e).then(function(t){_xx_util2.default.hideAll();var a=s,e=t.data;s.refresh||(e.list=[].concat(_toConsumableArray(a.list),_toConsumableArray(e.list)));var i=e.list,o=new app.util.date;for(var r in i)i[r].create_time&&(i[r].create_time1=o.dateToStr("YY/MM/DD",o.longToDate(1e3*i[r].create_time)),i[r].create_time2=o.dateToStr("HH:mm",o.longToDate(1e3*i[r].create_time))),"order"==i[r].sign&&(i[r].countText="，详情请查看订单中心并发货"),"praise"==i[r].sign&&2==i[r].type&&(1==i[r].count&&(i[r].countText="，TA正在了解你"),2!=i[r].count&&3!=i[r].count&&4!=i[r].count||(i[r].countText="，你成功的吸引了TA"),4<i[r].count&&(i[r].countText="，高意向客户立刻主动沟通")),"view"==i[r].sign&&(1==i[r].type&&(1==i[r].count&&(i[r].countText="，尽快把握商机"),2==i[r].count&&(i[r].countText="，潜在购买客户"),3==i[r].count&&(i[r].countText="，高意向客户成交在望"),3<i[r].count&&(i[r].countText="，购买欲望强烈")),3!=i[r].type&&6!=i[r].type||(2==i[r].count&&(i[r].countText="，赶快主动沟通"),2<i[r].count&&(i[r].countText="，高意向客户成交在望")),6==i[r].type&&1==i[r].count&&(i[r].countText="，看来TA对公司感兴趣")),d||(d=i[0].create_time1),d==i[r].create_time1&&(i[r].showTime=1),0<r&&(i[r].create_time1!=i[r-1].create_time1?(d=i[r].create_time1,i[r].showTime=1):i[r].showTime=0);n.setData({viewList:e,"viewList.page":s.page,"viewList.refresh":!1})})},toGetStaffFollow:function(){var c=this,t=c.data,a=t.param,u=t.followList,f=t.currentRadarTime,e={page:u.page,client_id:a.id};a.staff_id&&(e.staff_id=a.staff_id,e.client_id=a.client_id),u.refresh||_xx_util2.default.showLoading(),_index.bossModel.getStaffFollow(e).then(function(t){_xx_util2.default.hideAll();var a=u,e=t.data;u.refresh||(e.list=[].concat(_toConsumableArray(a.list),_toConsumableArray(e.list)));var i=e.list,o=new app.util.date;for(var r in i)i[r].create_time&&(i[r].create_time1=o.dateToStr("YY/MM/DD",o.longToDate(1e3*i[r].create_time)),i[r].create_time2=o.dateToStr("HH:mm",o.longToDate(1e3*i[r].create_time))),"praise"==i[r].sign&&2==i[r].type&&(1==i[r].count&&(i[r].countText="，TA正在了解你"),2!=i[r].count&&3!=i[r].count&&4!=i[r].count||(i[r].countText="，你成功的吸引了TA"),4<i[r].count&&(i[r].countText="，高意向客户立刻主动沟通")),"view"==i[r].sign&&(1==i[r].type&&(1==i[r].count&&(i[r].countText="，尽快把握商机"),2==i[r].count&&(i[r].countText="，潜在购买客户"),3==i[r].count&&(i[r].countText="，高意向客户成交在望"),3<i[r].count&&(i[r].countText="，购买欲望强烈")),3!=i[r].type&&6!=i[r].type||(2==i[r].count&&(i[r].countText="，赶快主动沟通"),2<i[r].count&&(i[r].countText="，高意向客户成交在望")),6==i[r].type&&1==i[r].count&&(i[r].countText="，看来TA对公司感兴趣")),f||(f=i[0].create_time1),f==i[r].create_time1&&(i[r].showTime=1),0<r&&(i[r].create_time1!=i[r-1].create_time1?(f=i[r].create_time1,i[r].showTime=1):i[r].showTime=0);var n=c.data.toFollowType;for(var s in e.list)n.push(0);var d=c.data.param.fromstatus,l=c.data.img2;"boss"==d&&(l=app.globalData.avatarUrlStaff),c.setData({followList:e,"followList.page":u.page,"followList.refresh":!1,toFollowType:n,img2:l})})},pickerSelected:function(t){var a=this,e=t.currentTarget.dataset.status;"interest"==e?(a.setData({interest:t.detail.value}),a.getInterest()):"activity"==e?(a.setData({activity:t.detail.value}),a.getActivity()):"client"==e&&(a.setData({client:t.detail.value}),a.getClientInteraction())},listenerDatePickerSelected:function(t){var a=t.detail.value,e=a.split("-");this.setData({date:a,year:e[0],month:e[1],day:e[2],content:"将预计成交日期更改为"+a}),this.getDealDate(),this.adds()},getDealDate:function(){var i=this,t={client_id:i.data.param.id},a=i.data,e=a.date,o=a.param;e&&(t.date=e),o.staff_id&&(t.staff_id=o.staff_id),app.util.request({url:"entry/wxapp/DealDate",cachetime:"30",method:"POST",data:t,success:function(t){if(!t.data.errno&&t.data.data.date){var a=t.data.data.date,e=a.split("-");i.setData({date:a,year:e[0],month:e[1],day:e[2]})}}})},getRate:function(){var a=this,t={client_id:a.data.param.id},e=a.data.param;e.staff_id&&(t.staff_id=e.staff_id),app.util.request({url:"entry/wxapp/Rate",cachetime:"30",method:"POST",data:t,success:function(t){t.data.errno||a.setData({rate:t.data.data.rate})}})},Edit:function(t){var a="/longbing_card/staffs/pages/custom/editInfo/editInfo?id="+this.data.param.id;this.data.param.fromstatus&&(a=a+"&fromstatus="+this.data.param.fromstatus+"&staff_id="+this.data.param.staff_id),wx.navigateTo({url:a})},addslables:function(t){var a="/longbing_card/staffs/pages/custom/tag/tag?id="+this.data.param.id;this.data.param.fromstatus&&(a=a+"&fromstatus="+this.data.param.fromstatus+"&staff_id="+this.data.param.staff_id),wx.navigateTo({url:a})},addsRecord:function(t){this.setData({RecordShow:!0,vagueShow:!0,content:""})},textValue:function(t){this.setData({content:t.detail.value})},cancel:function(t){this.setData({RecordShow:!1,vagueShow:!1,textValue:"",content:""})},adds:function(t){var a=this;if(a.setData({RecordShow:!1,vagueShow:!1}),"toSave"==a.data.toFolledit){var e={client_id:a.data.param.id,content:this.data.content};-1<a.data.content.indexOf("将预计成交日期更改为")&&(e.type=2),app.util.request({url:"entry/wxapp/followInsert",cachetime:"30",method:"POST",data:e,success:function(t){t.data.errno||(a.setData({"followList.page":1,"followList.refresh":!0,currentIndex:1,currentTab:"follow"}),a.toGetStaffFollow(),a.setData({content:""}))}})}else a.getFollowEdit()},index99:function(t){this.setData({RecordShow:!1,vagueShow:!1,textValue:""})},BottomOK:function(t){var a=this,e=a.data,i=e.tmp_errno;e.Customer.tmpVal;1==i?app.util.request({url:"entry/wxapp/Deal",cachetime:"30",method:"POST",data:{client_id:a.data.param.id},success:function(t){t.data.errno||a.setData({tmp_errno:0,"Customer.value1":"已成交"})}}):0==i&&app.util.request({url:"entry/wxapp/CancelDeal",cachetime:"30",method:"POST",data:{client_id:a.data.param.id},success:function(t){t.data.errno||a.setData({tmp_errno:1},function(){a.shuaxin()})}})},ifOK:function(t){var e=this;app.util.request({url:"entry/wxapp/CheckDeal",cachetime:"30",method:"POST",data:{client_id:e.data.param.id},success:function(t){if(!t.data.errno){console.log(t.data,"//////////////  res.data");var a=0;"未成交"==t.data.message&&(a=1),e.setData({tmp_errno:a})}}})},init_bar:function(t){var o=this;"1"==t&&this.barComponent.init(function(t,a,e){var i=echarts.init(t,null,{width:a,height:e});return i.setOption(o.getBarOption()),i}),"2"==t&&this.barComponent2.init(function(t,a,e){var i=echarts.init(t,null,{width:a,height:e});return i.setOption(o.getBarOption2()),i})},getBarOption:function(){return{legend:{orient:"vertical",top:"10%",right:"10%",data:this.data.ai_Interest_x},series:[{type:"pie",center:["30%","40%"],radius:["40%","60%"],avoidLabelOverlap:!1,label:{normal:{show:!1,position:"center"}},data:this.data.ai_Interest_y}]}},getBarOption2:function(){var t;return{grid:{left:"15%",right:"15%",top:"10%",bottom:"15%"},xAxis:(t={type:"category",minInterval:"100",boundaryGap:!1},_defineProperty(t,"minInterval","1"),_defineProperty(t,"data",this.data.ai_active_x),_defineProperty(t,"axisLabel",{showMinLabel:!0}),t),yAxis:{type:"value"},series:[{symbol:"none",data:this.data.ai_active_y,type:"line",areaStyle:{color:"#e89e9e"}}]}},getInterest:function(){var o=this,t={client_id:o.data.param.id,type:1*o.data.interest+1},a=o.data.param;a.staff_id&&(t.staff_id=a.staff_id),app.util.request({url:"entry/wxapp/Interest",cachetime:"30",method:"POST",data:t,success:function(t){if(!t.data.errno){var a=t.data.data,e=[],i=[];a.qr&&(e.push("名片"+a.qr.count+"("+a.qr.rate+"%)"),i.push({value:a.qr.count,name:"名片"+a.qr.count+"("+a.qr.rate+"%)"})),a.timeline&&(e.push("动态"+a.timeline.count+"("+a.timeline.rate+"%)"),i.push({value:a.timeline.count,name:"动态"+a.timeline.count+"("+a.timeline.rate+"%)"})),a.goods&&(e.push("产品"+a.goods.count+"("+a.goods.rate+"%)"),i.push({value:a.goods.count,name:"产品"+a.goods.count+"("+a.goods.rate+"%)"})),a.custom_qr&&(e.push("自定义码"+a.custom_qr.count+"("+a.custom_qr.rate+"%)"),i.push({value:a.custom_qr.count,name:"自定义码"+a.custom_qr.count+"("+a.custom_qr.rate+"%)"})),0==e.length&&(e.push("暂无数据(100%)"),i.push({value:100,name:"暂无数据(100%)"})),o.setData({ai_Interest_x:e,ai_Interest_y:i}),o.barComponent=o.selectComponent("#mychart"),o.init_bar("1")}}})},getActivity:function(){var o=this,t={client_id:o.data.param.id,type:1*o.data.activity+1},a=o.data.param;a.staff_id&&(t.staff_id=a.staff_id),app.util.request({url:"entry/wxapp/Activity",cachetime:"30",method:"POST",data:t,success:function(t){if(!t.data.errno){var a=t.data.data.reverse(),e=[],i=[];a.forEach(function(t){var a=t.date;e.push(a.slice(5)),i.push(t.count)}),o.setData({ai_active_x:e,ai_active_y:i}),o.barComponent2=o.selectComponent("#mychart2"),o.init_bar("2")}}})},getClientInteraction:function(){var o=this,t={client_id:o.data.param.id,type:1*o.data.client+1},a=o.data.param;a.staff_id&&(t.staff_id=a.staff_id),app.util.request({url:"entry/wxapp/clientInteraction",cachetime:"30",method:"POST",data:t,success:function(t){if(!t.data.errno){var a=t.data.data;for(var e in a){var i=parseInt(a[e].rate/100*200);a[e].width=i}o.setData({ai_Interaction:a})}}})},getAnalysis:function(){this.getInterest(),this.getActivity(),this.getClientInteraction()},shuaxin:function(t){var e=this,a={client_id:e.data.param.id},i=e.data.param;i.staff_id&&(a.staff_id=i.staff_id),app.util.request({url:"entry/wxapp/clientInfo",cachetime:"30",method:"POST",data:a,success:function(t){if(!t.data.errno){var a=t.data.data;"0"==a.is_new||("1"==a.is_new?a.value1="新客户":"2"==a.is_new?a.value1="跟进中":"3"==a.is_new&&(a.value1="已成交")),e.setData({Customer:a})}}})},firsttime:function(){var a=this;app.util.request({url:"entry/wxapp/firstTime",cachetime:"30",method:"POST",data:{client_id:a.data.param.id},success:function(t){t.data.errno||a.setData({firstTime:t.data.data.time})}})},biaoqian:function(){var a=this,t={target_id:a.data.param.id},e=a.data.param;e.staff_id&&(t.staff_id=e.staff_id),app.util.request({url:"entry/wxapp/Labels",cachetime:"30",method:"POST",data:t,success:function(t){t.data.errno||a.setData({Labellist:t.data.data})}})},qq:function(){var t=this,e=t.data.param.id,i=t.data.Customer.nickName,o=t.data.Customer.avatarUrl;t.data.Customer.phone;app.util.request({url:"entry/wxapp/Staff",cachetime:"30",method:"POST",data:{target_id:t.data.param.id},success:function(t){var a=t.data.data.avatarUrl;wx.navigateTo({url:"/longbing_card/chat/staffChat/staffChat?chat_to_uid="+e+"&contactUserName="+i+"&chatAvatarUrl="+o+"&toChatAvatarUrl="+a})}})},getFollowEdit:function(){var o=this,t={id:o.data.toFolledit,content:o.data.content};app.util.request({url:"entry/wxapp/FollowUpdate",cachetime:"30",method:"POST",data:t,success:function(t){if(!t.data.errno){wx.showToast({icon:"none",title:"已成功修改跟进记录！",duration:1e3});var a=o.data.followList.list,e=o.data.toFolledit;for(var i in a)e==a[i].id&&(a[i].content=o.data.content);o.setData({"followList.list":a,toFolledit:"toSave",currEditInd:"-1",content:""})}}})},getFollowDelete:function(o){var r=this,t={id:r.data.followList.list[o].id};app.util.request({url:"entry/wxapp/FollowDelete",cachetime:"30",method:"POST",data:t,success:function(t){if(!t.data.errno){wx.showToast({icon:"none",title:"已成功删除跟进记录！",duration:1e3});var a=r.data.followList.list,e=r.data.toFollowType;for(var i in a.splice(o,1),e)e[i]=0;r.setData({"followList.list":a,currEditInd:"-1",toFollowType:e})}}})},toSetStarMark:function(){var e=this,t={client_id:e.data.param.id};_index.staffModel.getStarMark(t).then(function(t){_xx_util2.default.hideAll();var a=1;1==e.data.Customer.start&&(a=0),e.setData({"Customer.start":a})})},toJump:function(t){var a=this,e=_xx_util2.default.getData(t),i=e.status,o=e.index,r=e.type,n=e.content;if("toCopyright"==i&&app.util.goUrl(t),"toCall"==i){if(!n)return!1;wx.makePhoneCall({phoneNumber:n,success:function(t){app.globalData.to_uid!=wx.getStorageSync("userid")&&a.toCopyRecord(r)}})}else if("toFollowEdit"==i){var s=a.data,d=s.currEditInd,l=s.toFollowType;0==r&&(l[d=o]=1),1==r&&(d="-1",l[o]=0),a.setData({currEditInd:d,toFollowType:l})}else"toFolledit"==i?(a.addsRecord(),a.setData({toFolledit:a.data.followList.list[o].id,content:a.data.followList.list[o].content})):"toFolldelete"==i?wx.showModal({title:"",content:"是否删除此条数据？",success:function(t){t.confirm&&a.getFollowDelete(o)}}):"toStarMark"==i&&a.toSetStarMark()},formSubmit:function(t){var a=this,e=t.detail.formId,i=t.detail.target.dataset.index,o=t.detail.target.dataset.status;a.toSaveFormIds(e);var r=!0;"analysis"==o&&(r=!1),a.setData({currentIndex:i,currentTab:o,isShowFooter:r}),app.util.showLoading(1),"browse"==o?(a.setData({"viewList.page":1,"viewList.refresh":!0}),a.toGetStaffView()):"follow"==o?(a.setData({"followList.page":1,"followList.refresh":!0}),a.toGetStaffFollow()):"analysis"==o&&a.getAnalysis(),wx.hideLoading()},toSaveFormIds:function(t){app.util.request({url:"entry/wxapp/formid",cachetime:"30",method:"POST",data:{formId:t},success:function(t){t.data.errno},fail:function(t){}})}}); 
