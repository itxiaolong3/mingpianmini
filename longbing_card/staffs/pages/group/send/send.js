var _xx_util=require("../../../../resource/js/xx_util.js"),_xx_util2=_interopRequireDefault(_xx_util),_index=require("../../../../resource/apis/index.js");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,a=Array(t.length);e<t.length;e++)a[e]=t[e];return a}return Array.from(t)}var app=getApp(),chatInput=require("../../../../chat/chat-input/chat-input.js");Page({data:{tagType:0,useMessageType:[],currUType:0,useMessage:[],showEditSec:!1,dataList:{page:1,total_page:1,list:[],refresh:!1,loading:!0}},onLoad:function(t){var e=this;wx.hideShareMenu();var a=app.util.url("entry/wxapp/upload"),s=getCurrentPages();s.length&&(s=s[getCurrentPages().length-1])&&s.__route__&&(a=a+"&m="+s.__route__.split("/")[0]);var i="",n={};if(t.status&&(n.status=t.status,"manager"==t.status&&(i="销售管家"),"message"==t.status)){i="群发";var o=getCurrentPages(),r=o[o.length-2].__viewData__;n.count=r.check_lable_count,n.lable_id=r.check_lable_id,n.lable_name=r.check_lable_name}t.type&&(n.type=t.type),wx.setNavigationBarTitle({title:i}),getApp().getConfigInfo(!0,!1).then(function(){e.setData({globalData:app.globalData,uploadUrl:a,paramObj:n},function(){e.initData(),"manager"==n.status&&e.toGetAdminRecord()})})},onReady:function(){},onShow:function(){},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){var t=this,e=t.data,a=e.paramObj,s=e.dataList;"manager"==a.status&&(s.page==s.total_page||s.loading||t.setData({"dataList.page":parseInt(s.page)+1,"dataList.loading":!0},function(){t.toGetAdminRecord()}))},onReachBottom:function(){},onPageScroll:function(t){},onShareAppMessage:function(t){},initData:function(){var t=this,e=wx.getSystemInfoSync();chatInput.init(this,{systemInfo:e,minVoiceTime:1,maxVoiceTime:60,startTimeDown:56,format:"mp3",sendButtonBgColor:"mediumseagreen",sendButtonTextColor:"white",extraArr:[]}),t.setData({pageHeight:e.windowHeight}),t.textButton(),t.extraButton(),t.getReplyList()},textButton:function(){var n=this;chatInput.setTextMessageListener(function(t){var s=t.success,e=t.e,i=t.fail,a={content:e.detail.value,lable_id:n.data.paramObj.lable_id};_index.staffModel.getGroupSend(a).then(function(a){_xx_util2.default.hideAll(),_xx_util2.default.showSuccess("发送成功"),setTimeout(function(){var t=n.data.paramObj;if(0==a.errno){var e=1;"message"==t.status&&"next"==t.type&&(e=2),wx.navigateBack({delta:e}),s(!0)}-1==a.errno&&(wx.showModal({title:"",content:a.message,showCancel:!1,success:function(t){t.confirm}}),i(!1))},2e3)})})},extraButton:function(){var s=this;chatInput.clickExtraListener(function(t){var e=parseInt(t.currentTarget.dataset.index);1!==e?(wx.chooseImage({count:1,sizeType:["compressed"],sourceType:0===e?["album"]:["camera"],success:function(t){var e=t.tempFiles;wx.showLoading({title:"发送中..."}),wx.uploadFile({url:s.data.uploadUrl,filePath:e[0].path,name:"upfile",formData:{},success:function(t){wx.hideLoading();var e=JSON.parse(t.data).data.path,a={user_id:s.data.user_id,target_id:s.data.chat_to_uid,content:e,type:"image",uniacid:app.siteInfo.uniacid};a=JSON.stringify(a)}})}}),s.hideExtra()):wx.chooseVideo({maxDuration:10,success:function(t){t.tempFilePath,t.thumbTempFilePath;wx.showLoading({title:"发送中..."})},fail:function(t){},complete:function(t){}})}),chatInput.setExtraButtonClickListener(function(t){})},pageScrollToBottom:function(){wx.createSelectorQuery().select(".speak_box").boundingClientRect(function(t){wx.pageScrollTo({scrollTop:t.height})}).exec()},hideExtra:function(t){this.setData({"inputObj.extraObj.chatInputShowExtra":!1})},toGetAdminRecord:function(){var i=this,n=i.data.dataList;n.refresh||_xx_util2.default.showLoading();var t={page:n.page};_index.staffModel.getAdminRecord(t).then(function(t){_xx_util2.default.hideAll();var e=n,a=t.data;for(var s in e.list=e.list.reverse(),n.refresh||(a.list=[].concat(_toConsumableArray(e.list),_toConsumableArray(a.list))),a.list)a.list[s].last_time2=_xx_util2.default.formatTime(1e3*a.list[s].create_time);a.page=a.page,a.refresh=!1,a.loading=!1,a.list=a.list.reverse(),i.setData({dataList:a},function(){i.pageScrollToBottom()})})},toSendMessage:function(t){var s=this;_index.staffModel.getGroupSend(t).then(function(a){_xx_util2.default.hideAll(),_xx_util2.default.showSuccess("发送成功"),setTimeout(function(){var t=s.data.paramObj;if(0==a.errno){var e=1;"message"==t.status&&"next"==t.type&&(e=2),wx.navigateBack({delta:e})}-1==a.errno&&wx.showModal({title:"",content:a.message,showCancel:!1,success:function(t){t.confirm}})},2e3)})},getReplyList:function(){var i=this;app.util.request({url:"entry/wxapp/ReplyList",cachetime:"30",showLoading:!1,method:"POST",data:{},success:function(t){if(!t.data.errno){var e=t.data.data,a=i.data.useMessageType;for(var s in e)a.push(e[s].title);i.setData({useMessage:e,useMessageType:a})}},fail:function(t){}})},getAddReply:function(e){var a=this,s=a.data.useMessage,i=s[a.data.currUType].list;app.util.request({url:"entry/wxapp/AddReply",cachetime:"30",showLoading:!1,method:"POST",data:{content:e},success:function(t){t.data.errno||(i.push({id:t.data.data.id,content:e}),a.setData({currUType:0,useMessage:s,showAddUseSec:!1}))},fail:function(t){}})},getEditReply:function(e){var a=this,s=a.data.useMessage,i=s[a.data.currUType].list;app.util.request({url:"entry/wxapp/EditReply",cachetime:"30",showLoading:!1,method:"POST",data:{id:i[a.data.toEditInd].id,content:e},success:function(t){t.data.errno||(i[a.data.toEditInd].content=e,a.setData({useMessage:s,showAddUseSecContent:"",showAddUseSec:!1,showEditSec:!1}))},fail:function(t){a.setData({showAddUseSecContent:"",showAddUseSec:!1,showEditSec:!1})}})},getDelReply:function(e){var a=this,s=a.data.useMessage,i=s[a.data.currUType].list;app.util.request({url:"entry/wxapp/DelReply",cachetime:"30",showLoading:!1,method:"POST",data:{id:i[e].id},success:function(t){t.data.errno||(wx.showToast({icon:"none",title:"已成功删除数据！",duration:1e3}),i.splice(e,1),a.setData({useMessage:s,showEditSec:!1}))},fail:function(t){a.setData({showEditSec:!1})}})},toJump:function(t){var e=this,a=_xx_util2.default.getData(t),s=a.status,i=a.type,n=a.index,o=a.content;if("toHome"==s||"toJumpUrl"==s)app.util.goUrl(t);else if("toStarMark"==s);else if("previewImage"==s)wx.previewImage({current:o,urls:[o]});else if("toCopy"==s)app.util.goUrl(t);else if("toUse"==s)e.setData({showUseMessage:!0});else if("toSetTab"==s)e.setData({currUType:n,showEditSec:!1});else if("toSendMessage"==s){var r={content:o,lable_id:e.data.paramObj.lable_id};e.setData({showUseMessage:!1,showAddUseSec:!1,showAddUseSecContent:"",toEditInd:""},function(){e.toSendMessage(r)})}else if("toClose"==s)e.setData({showUseMessage:!1,showAddUseSec:!1,showAddUseSecContent:"",toEditInd:""});else if("toAdd"==s)e.setData({showAddUseSec:!0});else if("toEditSec"==s){var u;1==i&&(u=!1),0==i&&(u=!0),e.setData({showEditSec:u})}else"toEdit"==s?e.setData({showAddUseSecContent:o,showAddUseSec:!0,toEditInd:n}):"toDelete"==s&&wx.showModal({title:"",content:"是否确认删除此数据？",success:function(t){t.confirm?e.getDelReply(n):e.setData({showEditSec:!1})}})},formSubmit:function(t){var e=this,a=t.detail.formId,s=_xx_util2.default.getFromData(t).status;if(e.toSaveFormIds(a),"toJumpUrl"==s)_xx_util2.default.goUrl(t,!0);else if("toCancel"==s)e.setData({showAddUseSec:!1,showAddUseSecContent:"",toEditInd:""});else if("toSaveUseMessage"==s){var i=t.detail.value.newuse;e.data.showAddUseSecContent?e.getEditReply(i):e.getAddReply(i)}},toSaveFormIds:function(t){app.util.request({url:"entry/wxapp/formid",cachetime:"30",showLoading:!1,method:"POST",data:{formId:t},success:function(t){t.data.errno},fail:function(t){}})}}); 
