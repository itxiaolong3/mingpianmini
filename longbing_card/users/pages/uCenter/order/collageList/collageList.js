var app=getApp();Page({data:{tabList:[{dotNum:"0",name:"全部拼团",status:"toCollage"},{dotNum:"0",name:"拼团中",status:"toCollage"},{dotNum:"0",name:"拼团成功",status:"toCollage"},{dotNum:"0",name:"拼团失败",status:"toCollage"}],currentIndex:0,globalData:{},more:!0,loading:!1,isEmpty:!1,show:!1,toShowWxPayStatus:!1,toWxPayStatus:0},onLoad:function(t){console.log(t,"options");wx.hideShareMenu(),t.currentTab&&this.setData({currentIndex:t.currentTab,toShowWxPayStatus:!1,globalData:app.globalData})},onReady:function(){},onShow:function(){var t=this;0==t.data.toShowWxPayStatus&&(app.util.showLoading(1),t.setData({dataList:[],page:1,more:!0,loading:!1,isEmpty:!1,show:!1}),t.getListData(),wx.hideLoading())},onHide:function(){wx.hideLoading()},onUnload:function(){wx.hideLoading()},onPullDownRefresh:function(){app.util.showLoading(1);this.setData({dataList:[],page:1,more:!0,loading:!1,isEmpty:!1,show:!1}),this.getListData(),wx.showNavigationBarLoading(),wx.stopPullDownRefresh(),wx.hideLoading()},onReachBottom:function(){},onShareAppMessage:function(){},getShopcollagenumber:function(){var o=this;app.util.request({url:"entry/wxapp/shopcollagenumber",cachetime:"30",method:"POST",data:{},success:function(t){if(console.log("shopcollagenumber ==>",t),!t.data.errno){var a=o.data.tabList;a[0].dotNum=0,a[1].dotNum=t.data.data.going,a[2].dotNum=t.data.data.suc,a[3].dotNum=t.data.data.fail,o.setData({tabList:a})}},fail:function(t){console.log("shopcollagenumber ==> fail ==> ",t)}})},getListData:function(){var i=this;app.util.request({url:"entry/wxapp/shopmycollage",cachetime:"30",method:"POST",data:{type:i.data.currentIndex},success:function(t){if(console.log("shopmycollage ==>",t),!t.data.errno){var a=t.data.data;for(var o in 0==a.length&&i.setData({more:!1,loading:!1,isEmpty:!0,show:!0}),a){for(var e in a[o].order_info)a[o].user_id==a[o].order_info[e].user_id&&(a[o].order_info_2=a[o].order_info[e]);a[o].collage_info.number_2=parseInt((a[o].order_info_2.total_price-a[o].order_info_2.freight)/a[o].collage_info.price)}i.setData({dataList:a}),i.getShopcollagenumber()}},fail:function(t){console.log("shopmycollage ==> fail ==> ",t)}})},getShopcancelorder:function(t,o){var e=this;console.log(t,"order_id");var i=e.data.dataList;app.util.request({url:"entry/wxapp/shopcancelorder",cachetime:"30",method:"POST",data:{id:t},success:function(t){if(console.log("shopcancelorder ==>",t),!t.data.errno){var a=e.data.currentIndex;0==a&&wx.showToast({icon:"success",title:"已取消订单",duration:2e3,success:function(){setTimeout(function(){i.splice(o,1),e.setData({dataList:i})},1e3)}}),1==a&&(i.splice(o,1),e.setData({dataList:i}))}},fail:function(t){console.log("shopcancelorder ==> fail ==> ",t)}})},getShopdelorder:function(t,a){var o=this,e=o.data.dataList;app.util.request({url:"entry/wxapp/shopdelorder",cachetime:"30",method:"POST",data:{id:t},success:function(t){console.log("shopdelorder ==>",t),t.data.errno||wx.showToast({icon:"success",title:"已删除拼团",duration:2e3,success:function(){setTimeout(function(){e.splice(a,1),o.setData({dataList:e})},1e3)}})},fail:function(t){console.log("shopdelorder ==> fail ==> ",t)}})},getRefund:function(t,a){var o=this,e=o.data.dataList;app.util.request({url:"entry/wxapp/Refund",cachetime:"30",method:"POST",data:{order_id:t},success:function(t){console.log("Refund ==>",t),t.data.errno||wx.showToast({icon:"success",title:"已申请退款",duration:2e3,success:function(){setTimeout(function(){e[a].order_info_2.pay_status=2,o.setData({dataList:e})},1e3)}})},fail:function(t){console.log("Refund ==> fail ==> ",t)}})},getWxPay:function(t,a){var o=this;app.util.showLoading(1);var e=o.data.dataList;app.util.request({url:"entry/wxapp/Pay",cachetime:"30",method:"POST",data:{order_id:t},success:function(t){console.log("Pay ==>",t),t.data&&t.data.data&&!t.data.errno&&(t.data.data.collage_id&&o.setData({pay_collage_id:t.data.data.collage_id}),wx.hideLoading(),wx.requestPayment({timeStamp:t.data.data.timeStamp,nonceStr:t.data.data.nonceStr,package:t.data.data.package,signType:"MD5",paySign:t.data.data.paySign,success:function(t){wx.showToast({icon:"success",image:"/longbing_card/resource/images/alert.png",title:"支付成功",duration:2e3,success:function(){setTimeout(function(){wx.hideLoading(),wx.navigateTo({url:"/longbing_card/users/pages/shop/releaseCollage/releaseCollage?id="+e[a].collage_info.goods_id+"&status=toShare&to_uid="+e[a].order_info.to_uid+"&collage_id="+o.data.pay_collage_id}),o.setData({toWxPayStatus:0,toShowWxPayStatus:!1})},1e3)}})},fail:function(t){wx.showToast({icon:"fail",image:"/longbing_card/resource/images/error.png",title:"支付失败",duration:2e3,success:function(){setTimeout(function(){o.setData({toWxPayStatus:0,toShowWxPayStatus:!0}),wx.hideLoading()},1500)}})},complete:function(t){o.setData({toShowWxPayStatus:!0})}}))},fail:function(t){console.log("Pay ==> fail ==>",t),wx.hideLoading(),wx.showModal({title:"系统提示",content:t.data.message?"支付失败，"+t.data.message:"支付失败，请重试",showCancel:!1,success:function(t){t.confirm&&o.setData({toWxPayStatus:0,toShowWxPayStatus:!0})}})}})},toJump:function(t){var a=this,o=t.currentTarget.dataset.status,e=t.currentTarget.dataset.index,i=a.data.dataList;if("toProductDetail"==o||"toOrderDetail"==o||"toAgain"==o)app.util.goUrl(t);else if("toCancel"==o)a.getShopcancelorder(i[e].order_info_2.id,e);else if("toWxPay"==o){0==a.data.toWxPayStatus&&a.setData({toWxPayStatus:1},function(){a.getWxPay(i[e].order_info_2.id,e)})}else"toRefund"==o?a.getRefund(i[e].order_info_2.id,e):"toDelete"==o&&a.getShopdelorder(i[e].order_info_2.id,e)},formSubmit:function(t){var a=t.detail.formId,o=t.detail.target.dataset.index,e=t.detail.target.dataset.status;this.toSaveFormIds(a),"toCollage"==e&&(this.setData({currentIndex:o,currentTab:e}),this.getListData())},toSaveFormIds:function(t){app.util.request({url:"entry/wxapp/formid",cachetime:"30",method:"POST",data:{formId:t},success:function(t){t.data.errno},fail:function(t){}})}}); 
