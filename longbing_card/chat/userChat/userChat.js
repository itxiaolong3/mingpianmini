var _xx_util=require("../../resource/js/xx_util.js"),_xx_util2=_interopRequireDefault(_xx_util),_index=require("../../resource/apis/index.js");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}var sendGoodsId,ping_user_id,ping_chat_to_uid,app=getApp(),chatInput=require("../../chat/chat-input/chat-input.js"),timer=0,closeReconnect=!1,lockReconnect=!1,beginTime=0,endTime=0,heartCheck={timeout:3e3,timeoutObj:null,serverTimeoutObj:null,reset:function(){return console.log("heartCheck.reset.timer",timer),clearTimeout(timer),clearTimeout(this.timeoutObj),clearTimeout(this.serverTimeoutObj),this},start:function(){this.timeoutObj=setTimeout(function(){console.log("发送ping");var t={ping:!0,user_id:ping_user_id,target_id:ping_chat_to_uid};t=JSON.stringify(t),wx.sendSocketMessage({data:t,success:function(){console.log("发送ping成功",t)}})},this.timeout)}};Page({data:{user_id:"",chat_to_uid:"",chatid:"",contactUserName:"",chatAvatarUrl:"",toChatAvatarUrl:"",messageDate:"",chatInfo:{},messageList:[],limit:0,staffDefaultData:{title:"",phone:"",wechat:"",info:[{img:"/longbing_card/resource/images/img/1.png",name:"进入我的名片"},{img:"/longbing_card/resource/images/img/2.png",name:"查看公司官网"},{img:"/longbing_card/resource/images/img/3.png",name:"查看公司商品"},{img:"/longbing_card/resource/images/img/4.png",name:"查看我的动态"}]},countMessage:0},onLoad:function(r){var l=this;wx.hideShareMenu();var t=app.util.url("entry/wxapp/StaffCard");if((u=getCurrentPages()).length&&(u=u[getCurrentPages().length-1])&&u.__route__&&(t=t+"&m="+u.__route__.split("/")[0]),l.setData({staffUrl:t,user_id:wx.getStorageSync("userid")}),1==r.is_tpl){var e={user_id:wx.getStorageSync("userid"),target_id:r.to_uid};_index.baseModel.getChatInfo(e).then(function(t){console.log(t.data);var e=t.data,a=e.user_info,o=e.target_info,n=e.chat_id,i=o.nickName,s=o.avatarUrl,c=a.avatarUrl;l.setData({is_tpl:1,user_id:wx.getStorageSync("userid"),chat_to_uid:r.to_uid,"chatInfo.chat_id":n,chatAvatarUrl:c,toChatAvatarUrl:s,contactUserName:i,globalData:app.globalData},function(){ping_user_id=wx.getStorageSync("userid"),ping_chat_to_uid=l.data.chat_to_uid,l.initData(),l.getCardIndexData(),l.getChat()})})}else r.chat_to_uid&&l.setData({user_id:wx.getStorageSync("userid"),chat_to_uid:r.chat_to_uid,"chatInfo.chat_id":r.chatid,chatAvatarUrl:r.chatAvatarUrl,toChatAvatarUrl:r.toChatAvatarUrl,contactUserName:r.contactUserName,globalData:app.globalData},function(){ping_user_id=wx.getStorageSync("userid"),ping_chat_to_uid=l.data.chat_to_uid,l.initData(),l.getCardIndexData(),l.getChat()});if(wx.setNavigationBarTitle({title:l.data.contactUserName}),r.goods_id){sendGoodsId=r.goods_id,console.log(r.goods_id,"options.goods_id*************//");var a=getCurrentPages(),o=a[a.length-2].__viewData__;console.log("prevPage",o);var n="您好，我想咨询下产品【"+o.detailData.name+"】的相关信息。",i=o.detailData.cover_true,s={},c={user_id:l.data.user_id,target_id:l.data.chat_to_uid,content:n,type:"text",status:1,uniacid:app.siteInfo.uniacid},d={user_id:l.data.user_id,target_id:l.data.chat_to_uid,content:i,type:"image",status:1,uniacid:app.siteInfo.uniacid};c=JSON.stringify(c),d=JSON.stringify(d),s.text=c,s.image=d,l.setData({tmpGoodsData:s})}var u,g=app.util.url("entry/wxapp/upload");(u=getCurrentPages()).length&&(u=u[getCurrentPages().length-1])&&u.__route__&&(g=g+"&m="+u.__route__.split("/")[0]),l.setData({uploadUrl:g})},setLinkTitle:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";""!=t?(t+="...",wx.showNavigationBarLoading()):(t=this.data.contactUserName,wx.hideNavigationBarLoading()),wx.setNavigationBarTitle({title:t})},linkSocket:function(){var t=this;closeReconnect=!1,t.limit=0,t.setLinkTitle("连接中"),wx.connectSocket({url:app.globalData.wssUrl,success:function(){beginTime=new Date,console.log("连接成功"),t.initEventHandle()}})},initEventHandle:function(){var l=this;wx.onSocketMessage(function(t){if(l.setLinkTitle(),"pong"==t.data)console.log("WebSocket连接正常....");else{console.log("收到服务器内容：",t);var e=JSON.parse(t.data);if(console.log("收到服务器内容resData：",e),console.log(l.data.chat_to_uid,l.data.user_id,"chat_to_uid ==> user_id"),""!=e.data){console.log("res.data不为空",e.data);var a={};if(e.data2){if(e.data2.user_id==l.data.chat_to_uid&&e.data2.target_id==l.data.user_id){var o=e.data2.message_type;o||(o="text"),a={user_id:l.data.chat_to_uid,target_id:l.data.user_id,content:e.data2.content,type:o,status:1,uniacid:app.siteInfo.uniacid}}}else{var n=e.type;n||(n="text"),a={user_id:l.data.chat_to_uid,target_id:l.data.user_id,content:e.data,type:n,status:1,uniacid:app.siteInfo.uniacid}}if(a.content){var i=l.data.messageList,s=i.length;if(console.log(l.data.messageList,"that.data.messageList"),0<s)i[s-1].list.push(a);else{var c=new app.util.date,r=(c.dateToLong(new Date)/1e3).toFixed(0);r=c.dateToStr("yyyy-MM-DD HH:mm:ss",c.longToDate(1e3*r)),console.log(r,"////***555"),i.push({create_time:r,list:[a]})}console.log("res.data不为空 messageList",l.data.messageList),l.setData({messageList:i},function(){l.pageScrollToBottom()})}else console.log("不是当前聊天对象的数据,不添加到页面")}}}),wx.onSocketOpen(function(){console.log("WebSocket连接打开"),l.setLinkTitle(),heartCheck.reset().start()}),wx.onSocketError(function(t){console.log("WebSocket连接打开失败 closeReconnect"),l.reconnect()}),wx.onSocketClose(function(t){console.log("WebSocket 已关闭！ closeReconnect"),l.reconnect()})},unloadWebSocket:function(){console.log("开始卸载 WebSocket"),lockReconnect=closeReconnect=!0,heartCheck.reset(),wx.closeSocket({success:function(t){console.log("卸载创建 的  WebSocket 成功",t)},fail:function(t){console.log("卸载创建 的  WebSocket 失败",t)}}),heartCheck.reset()},reconnect:function(){var t=this;if(console.log("reconnect closeReconnect_1 lockReconnect",lockReconnect,closeReconnect,timer),closeReconnect)return clearTimeout(timer),!(lockReconnect=!(closeReconnect=!0));console.log("reconnect closeReconnect_2 lockReconnect",lockReconnect,closeReconnect,timer),lockReconnect&&closeReconnect||(this.setLinkTitle("重连中"),lockReconnect=!0,this.getWebSocketErrorTime(),clearTimeout(timer),this.data.limit<12?(timer=setTimeout(function(){console.log("reconnect","this.linkSocket()"),t.linkSocket(),lockReconnect=!1},5e3),this.setData({limit:this.data.limit+1})):wx.navigateBack())},onReady:function(){console.log("页面渲染完成")},onShow:function(){console.log("页面显示")},onHide:function(){console.log("页面隐藏")},onUnload:function(){console.log("页面卸载"),this.unloadWebSocket()},onPullDownRefresh:function(){console.log("监听用户下拉动作");var t=this;t.data.messageDate||1==t.data.messageList.length&&(messageDate=t.data.messageList[0].list[0].id,t.setData({messageDate:messageDate}),console.log(messageDate)),t.setData({show:!0}),t.getMessageList(),setTimeout(function(){wx.stopPullDownRefresh()},1e3)},onReachBottom:function(){console.log("监听页面上拉触底")},onPageScroll:function(t){},onShareAppMessage:function(t){console.log("用户点击右上角分_享")},getStaffCard:function(){var t,e=this;console.log("that.data.chat_to_uid",e.data.chat_to_uid),wx.request((_defineProperty(t={url:e.data.staffUrl,data:{user_id:e.data.chat_to_uid},header:{},method:"POST"},"header",{"content-type":"application/x-www-form-urlencoded"}),_defineProperty(t,"success",function(t){wx.hideNavigationBarLoading(),wx.hideLoading(),t.data.errno||(console.log(t,"getStaffCard getStaffCard */////////**"),e.setData({contactUserName:t.data.data.count.name,"staffDefaultData.phone":t.data.data.count.phone,"staffDefaultData.wechat":t.data.data.count.wechat,"staffDefaultData.title":"你好，我是"+t.data.data.count.name+"，有什么可以帮到你？记得联系我！"}))}),_defineProperty(t,"fail",function(t){console.log("fail ==> ",t)}),t))},initData:function(){this.linkSocket();var t=wx.getSystemInfoSync();chatInput.init(this,{systemInfo:t,minVoiceTime:1,maxVoiceTime:60,startTimeDown:56,format:"mp3",sendButtonBgColor:"mediumseagreen",sendButtonTextColor:"white",extraArr:[{picName:"choose_picture",description:"照片"}]}),this.setData({pageHeight:t.windowHeight}),this.textButton(),this.extraButton()},textButton:function(){var d=this;chatInput.setTextMessageListener(function(t){var r=t.success,e=t.e,a=t.fail,o=e.detail.value;console.log("userid**********************",d.data.user_id,d.data.chat_to_uid);var l={user_id:d.data.user_id,target_id:d.data.chat_to_uid,content:o,type:"text",status:1,uniacid:app.siteInfo.uniacid};l=JSON.stringify(l),console.log(l,"*************************************"),wx.sendSocketMessage({data:l,success:function(t){console.log(t,"success");var e=d.data.messageList,a=e.length;if(l=JSON.parse(l),0<a)e[a-1].list.push(l);else{var o=((i=new app.util.date).dateToLong(new Date)/1e3).toFixed(0);o=i.dateToStr("yyyy-MM-DD HH:mm:ss",i.longToDate(1e3*o)),e.push({create_time:o,list:[l]})}var n=(d.data||0).countMessage;d.setData({messageList:e,countMessage:1*n+1},function(){d.pageScrollToBottom()});var i,s=((i=new app.util.date).dateToLong(new Date)/1e3).toFixed(0),c=l.content;"image"==l.type&&(c="[图片]"),d.SendTemplate(s,c),r(!0)},fail:function(t){console.log(t,"fail"),a(!1)}})})},extraButton:function(){var o=this;chatInput.clickExtraListener(function(t){var e=parseInt(t.currentTarget.dataset.index);1!==e?(wx.chooseImage({count:1,sizeType:["compressed"],sourceType:0===e?["album"]:["camera"],success:function(t){var e=t.tempFiles;wx.showLoading({title:"发送中..."}),console.log(e),wx.uploadFile({url:o.data.uploadUrl,filePath:e[0].path,name:"upfile",formData:{},success:function(t){console.log(t,"******/////////////////////res"),wx.hideLoading();var e=JSON.parse(t.data).data.path,a={user_id:o.data.user_id,target_id:o.data.chat_to_uid,content:e,type:"image",status:1,uniacid:app.siteInfo.uniacid};a=JSON.stringify(a),o.toSendMessage(a,3)}})}}),chatInput.closeExtraView()):wx.chooseVideo({maxDuration:10,success:function(t){console.log(t);var e=t.tempFilePath,a=t.thumbTempFilePath;wx.showLoading({title:"发送中..."}),console.log(e,a)},fail:function(t){},complete:function(t){}})}),chatInput.setExtraButtonClickListener(function(t){console.log("Extra弹窗是否消息",t)})},pageScrollToBottom:function(){wx.createSelectorQuery().select(".speak_box").boundingClientRect(function(t){console.log(t),wx.pageScrollTo({scrollTop:t.height})}).exec()},toSendMessage:function(r,e){var l=this;wx.sendSocketMessage({data:r,success:function(t){console.log(t,"success");var e=l.data.messageList,a=e.length;if(r=JSON.parse(r),console.log(r,"*************************************"),0<a)e[a-1].list.push(r);else{var o=((i=new app.util.date).dateToLong(new Date)/1e3).toFixed(0);o=i.dateToStr("yyyy-MM-DD HH:mm:ss",i.longToDate(1e3*o)),console.log(o,"////***555"),e.push({create_time:o,list:[r]})}var n=(l.data||0).countMessage;l.setData({messageList:e,countMessage:1*n+1},function(){l.pageScrollToBottom()});var i,s=((i=new app.util.date).dateToLong(new Date)/1e3).toFixed(0);console.log("SendTemplate 客户发送给员工 模板消息");var c=r.content;"image"==r.type&&(c="[图片]"),l.SendTemplate(s,c)},fail:function(t){l.toSendMessage(r,e)}})},SendTemplate:function(t,e){app.util.request({url:"entry/wxapp/SendTemplate",cachetime:"30",showLoading:!1,method:"POST",data:{to_uid:this.data.chat_to_uid,date:t,content:e},success:function(t){console.log("SendTemplate ==>",t),t.data.errno},fail:function(t){}})},getChat:function(){var e=this;app.util.request({url:"entry/wxapp/chatId",cachetime:"30",showLoading:!1,method:"POST",data:{to_uid:e.data.chat_to_uid},success:function(t){console.log("chatId ==>",t),t.data.errno||(e.setData({chatInfo:t.data.data,chatAvatarUrl:t.data.data.user_info.avatarUrl,toChatAvatarUrl:t.data.data.target_info.avatarUrl}),e.getMessageList())},fail:function(t){}})},getMessageList:function(){var l=this,t={chat_id:l.data.chatInfo.chat_id};l.data.messageDate&&(t.create_time=l.data.messageDate),app.util.request({url:"entry/wxapp/messages",cachetime:"30",showLoading:!1,method:"POST",data:t,success:function(t){if(console.log("messages ==>",t),!t.data.errno){var e=t.data.data.list;if(0==e.length)return l.setData({more:!1,loading:!1,isEmpty:!0,show:!0}),!1;l.setData({loading:!0,messageDate:t.data.data.create_time});var a=l.data.messageList;1==l.data.onPullDownRefresh&&(a=[]),a=a.reverse();var o,n=new app.util.date;for(var i in e)e[i].create_time.length<12&&(e[i].create_time=n.dateToStr("yyyy-MM-DD HH:mm:ss",n.longToDate(1e3*e[i].create_time)));o=(e=e.reverse())[0].create_time,a.push({create_time:o,list:e}),a=a.reverse();var s=0;for(var c in a)s+=a[c].list.length;l.setData({messageList:a,onPullDownRefresh:!1,countMessage:s});var r=l.data.tmpGoodsData;r&&(l.toSendMessage(r.text,3),setTimeout(function(){l.toSendMessage(r.image,3),l.setData({tmpGoodsData:!1})},600))}},fail:function(t){console.log("message ==> fail ==> ",t)}})},getCardIndexData:function(){var a=this;_xx_util2.default.showLoading();var t={to_uid:a.data.chat_to_uid};_index.userModel.getCardShow(t).then(function(t){_xx_util2.default.hideAll(),console.log("getCardShow ==>",t.data);var e=t.data;a.setData({cardIndexData:e},function(){a.getStaffCard()})})},toJump:function(t){var e=this,a=t.currentTarget.dataset.status,o=t.currentTarget.dataset.index,n=t.currentTarget.dataset.type,i=t.currentTarget.dataset.content;if("toHome"==a)app.util.goUrl(t);else if("toSeeStaff"==a){var s="/longbing_card/pages/index/index?to_uid="+e.data.chat_to_uid+"&from_id="+app.globalData.from_id+"&currentTabBar=";0==o?s+="toCard":1==o?s+="toCompany":2==o?s+="toShop":3==o&&(s+="toNews"),wx.navigateTo({url:s})}else if("toCallCopy"==a){if(!i)return!1;2==n?wx.makePhoneCall({phoneNumber:i,success:function(t){e.toCopyRecord(n)}}):4==n&&wx.setClipboardData({data:i,success:function(t){wx.getClipboardData({success:function(t){e.toCopyRecord(n)}})}})}else"toCopy"==a?app.util.goUrl(t):"toCopyWechat"==a?(wx.setClipboardData({data:i,success:function(t){console.log(t),wx.getClipboardData({success:function(t){console.log("复制文本成功 ==>>",t.data)}})}}),e.toCopyRecord(n)):"toCallPhone"==a?(app.util.goUrl(t),e.toCopyRecord(n)):"toSaveCard"==a?wx.navigateTo({url:"/longbing_card/users/pages/card/share/share"}):"previewImage"==a&&(console.log(t),wx.previewImage({current:i,urls:[i]}))},toCopyRecord:function(t){app.util.request({url:"entry/wxapp/copyRecord",cachetime:"30",showLoading:!1,method:"POST",data:{type:t,to_uid:this.data.chat_to_uid},success:function(t){t.data.errno},fail:function(t){}})},formSubmit:function(t){var e=t.detail.formId;this.toSaveFormIds(e)},toSaveFormIds:function(t){app.util.request({url:"entry/wxapp/formid",cachetime:"30",showLoading:!1,method:"POST",data:{formId:t},success:function(t){t.data.errno},fail:function(t){console.log("fail ==> ",t)}})},getWebSocketErrorTime:function(){endTime=new Date;var t=beginTime;console.log("beginTime",beginTime,"endTime",endTime);var e=endTime.getTime()-t.getTime(),a=Math.floor(e/864e5),o=e%864e5,n=Math.floor(o/36e5),i=o%36e5,s=Math.floor(i/6e4),c=i%6e4,r=Math.round(c/1e3);console.log(" 相差 "+a+"天 "+n+"小时 "+s+" 分钟"+r+" 秒")}}); 
