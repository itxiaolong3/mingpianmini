var _xx_util=require("../../resource/js/xx_util.js"),_xx_util2=_interopRequireDefault(_xx_util),_index=require("../../resource/apis/index.js");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _toConsumableArray(t){if(Array.isArray(t)){for(var a=0,e=Array(t.length);a<t.length;a++)e[a]=t[a];return e}return Array.from(t)}var app=getApp();Page({data:{globalData:{},messageTime:"",staffInfo:[],dataList:{page:1,total_page:"",list:[],refresh:!1,loading:!0}},onLoad:function(t){},onReady:function(){},onShow:function(){app.util.showLoading(1);var t=this,a={to_uid:wx.getStorageSync("userid")};_index.baseModel.getClientUnread(a).then(function(t){var a=t.data.count.staff_count;app.globalData.badgeNum=a,getApp().setMsgBadge(app.globalData.badgeNum)}),wx.hideShareMenu();var e=(new app.util.date).dateToLong(new Date);t.setData({messageTime:(e/1e3).toFixed(0),globalData:app.globalData,"dataList.page":1,"dataList.refresh":!0},function(){t.getStaffInfo(),t.toGetMessageList(),wx.hideLoading()})},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){var t=this;app.util.showLoading(1),app.globalData.configInfo=!1,getApp().getConfigInfo(!0,!1).then(function(){t.setData({globalData:app.globalData},function(){t.setData({"dataList.refresh":!0,"dataList.page":1},function(){wx.showNavigationBarLoading(),t.toGetMessageList()})})})},onReachBottom:function(){var t=this,a=t.data.dataList;a.page==a.total_page||a.loading||t.setData({"dataList.page":parseInt(a.page)+1,"dataList.loading":!0},function(){t.toGetMessageList()})},onPageScroll:function(t){},onShareAppMessage:function(t){},getStaffInfo:function(){var a=this;app.util.request({url:"entry/wxapp/Staff",cachetime:"30",method:"POST",data:{},success:function(t){t.data.errno||a.setData({staffInfo:t.data.data})},fail:function(t){}})},toGetMessageList:function(){var o=this,n=o.data.dataList,t={page:n.page};n.refresh||_xx_util2.default.showLoading(),_index.staffModel.getMessageList(t).then(function(t){_xx_util2.default.hideAll(),console.log("getMessageList ==>",t.data);var a=n,e=t.data;for(var i in n.refresh||(e.list=[].concat(_toConsumableArray(a.list),_toConsumableArray(e.list))),e.list)e.list[i].last_time2=_xx_util2.default.ctDate(1*e.list[i].last_time);e.last.last_time2=_xx_util2.default.ctDate(1*e.last.create_time),e.page=e.page,e.refresh=!1,e.loading=!1,o.setData({dataList:e})})},toJump:function(t){var a=t.currentTarget.dataset.status,e=t.currentTarget.dataset.index,i=this.data.dataList.list;if("toCopyright"==a||"toJumpUrl"==a)app.util.goUrl(t);else{var o=i[e].user_id;if(o==wx.getStorageSync("userid")&&(o=i[e].target_id),"toUserInfo"==a)wx.navigateTo({url:"/longbing_card/staffs/pages/custom/detail/detail?id="+o});else if("toChat"==a){var n=i[e].user.nickName;n||(n="新客户");var r=i[e].user.avatarUrl;r||(r=app.globalData.defaultUserImg);var s=i[e].phone;wx.navigateTo({url:"/longbing_card/chat/staffChat/staffChat?chat_to_uid="+o+"&contactUserName="+n+"&chatid="+i[e].id+"&chatAvatarUrl="+this.data.staffInfo.avatarUrl+"&toChatAvatarUrl="+r+"&clientPhone="+s})}}},formSubmit:function(t){var a=t.detail.formId,e=t.detail.target.dataset.status;this.toSaveFormIds(a),"toHome"==e&&wx.reLaunch({url:"/longbing_card/pages/index/index?to_uid="+wx.getStorageSync("userid")+"&from_id="+wx.getStorageSync("userid")+"&currentTabBar=toCard"})},toSaveFormIds:function(t){app.util.request({url:"entry/wxapp/formid",cachetime:"30",method:"POST",data:{formId:t},success:function(t){t.data.errno},fail:function(t){}})}}); 
